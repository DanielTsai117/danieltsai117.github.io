<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lucky Draw</title>
</head>
<body>

  <h1>Lucky Draw</h1>

  <form id="lotteryForm">
    <label for="fileInput">上傳抽籤名單 (CSV 檔案):</label>
    <input type="file" id="fileInput" accept=".csv" required>
    
    <label for="numWinners">抽籤人數:</label>
    <input type="number" id="numWinners" min="1" required>
    
    <button type="button" onclick="drawWinners()">進行抽籤</button>
  </form>

  <div id="winnersList"></div>

  <button id="downloadButton" style="display:none;" onclick="downloadWinnersCSV()">下載中籤名單</button>

  <script>
    let participants = [];

    function drawWinners() {
      const fileInput = document.getElementById('fileInput');
      const numWinnersInput = document.getElementById('numWinners');
      const winnersList = document.getElementById('winnersList');
      const downloadButton = document.getElementById('downloadButton');

      const numWinners = parseInt(numWinnersInput.value);
      
      if (isNaN(numWinners) || numWinners <= 0) {
        alert('請輸入有效的抽籤人數。');
        return;
      }

      const file = fileInput.files[0];

      if (!file) {
        alert('請上傳抽籤名單檔案。');
        return;
      }

      const reader = new FileReader();

      reader.onload = function (e) {
        const content = e.target.result;
        participants = content.split('\n').map(line => line.trim());

        if (participants.length < numWinners) {
          alert('抽籤人數大於參加人數。');
          return;
        }

        const selectedWinners = [];
        while (selectedWinners.length < numWinners) {
          const randomIndex = Math.floor(Math.random() * participants.length);
          const winner = participants.splice(randomIndex, 1)[0];
          selectedWinners.push(winner);
        }

        winnersList.innerHTML = '<h2>中籤名單:</h2><ul>' + selectedWinners.map(winner => `<li>${winner}</li>`).join('') + '</ul>';
        downloadButton.style.display = 'block';
      };

      reader.readAsText(file);
    }

    function downloadWinnersCSV() {
      const csvContent = 'data:text/csv;charset=utf-8,' + participants.join('\n');
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', '中籤名單.csv');
      document.body.appendChild(link);
      link.click();
    }
  </script>

</body>
</html>