<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抽籤程式</title>
</head>
<body>
    <h1>抽籤程式</h1>

    <input type="file" id="fileInput" accept=".csv">
    <br>
    <label for="numWinners">抽籤人數：</label>
    <input type="number" id="numWinners" min="1" value="1">
    <br>
    <button onclick="drawWinners()">抽籤</button>

    <h2>中籤名單</h2>
    <ul id="winnersList"></ul>

    <a id="downloadLink" style="display:none">下載中籤名單</a>

    <script>
        let participants = [];

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csv = e.target.result;
                    participants = parseCSV(csv);
                };
                reader.readAsText(file);
            }
        }

        function parseCSV(csv) {
            const lines = csv.split('\n');
            const participants = [];
            for (const line of lines) {
                const [name] = line.split(',').map(value => value.trim());
                if (name) {
                    participants.push({ name, selected: false });
                }
            }
            return participants;
        }

        function drawWinners() {
            const numWinners = parseInt(document.getElementById('numWinners').value, 10);
            const winnersList = document.getElementById('winnersList');
            const downloadLink = document.getElementById('downloadLink');
            
            if (participants.length === 0 || isNaN(numWinners) || numWinners <= 0) {
                alert('請確保已上傳名單並輸入正確的抽籤人數。');
                return;
            }

            // Reset selected status
            participants.forEach(participant => participant.selected = false);

            if (numWinners > participants.length) {
                alert('抽籤人數大於名單人數。');
                return;
            }

            const winners = [];
            for (let i = 0; i < numWinners; i++) {
                let selectedParticipant;
                do {
                    selectedParticipant = getRandomParticipant();
                } while (selectedParticipant.selected);
                selectedParticipant.selected = true;
                winners.push(selectedParticipant.name);
            }

            // Display winners on the webpage
            winnersList.innerHTML = '';
            winners.forEach(winner => {
                const listItem = document.createElement('li');
                listItem.textContent = winner;
                winnersList.appendChild(listItem);
            });

            // Create CSV content for download
            const csvContent = winners.map(winner => `${winner}\n`).join('');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);

            // Display download link
            downloadLink.href = url;
            downloadLink.download = 'winners.csv';
            downloadLink.style.display = 'block';
        }

        function getRandomParticipant() {
            const availableParticipants = participants.filter(participant => !participant.selected);
            const index = Math.floor(Math.random() * availableParticipants.length);
            return availableParticipants[index];
        }
    </script>
</body>
</html>
